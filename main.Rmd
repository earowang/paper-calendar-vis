---
author:
  - name: Earo Wang
    affiliation: Monash University
    address: >
      Department of Econometrics and Business Statistics,
      Monash University, VIC 3800
      Australia
    email: \email{earo.wang@monash.edu}
  - name: Dianne Cook
    affiliation: Monash University
    address: >
      Department of Econometrics and Business Statistics,
      Monash University, VIC 3800
      Australia
    email: \email{dicook@monash.edu}
  - name: Rob J Hyndman
    affiliation: Monash University
    address: >
      Department of Econometrics and Business Statistics,
      Monash University, VIC 3800
      Australia
    email: \email{rob.hyndman@monash.edu}
title:
  formatted: "Calendar-based graphics for visualizing people's daily schedules"
  plain: "Calendar-based graphics for visualizing people's daily schedules"
abstract: >
  This paper describes a \code{frame\_calendar} function that organizes and displays temporal data, collected on sub-daily resolution, into a calendar layout. Calendars are broadly used in society to display temporal information, and events. The \code{frame\_calendar} utilizes linear algebra on the date  variable to create the layout. It utilizes the grammar of graphics to create the plots inside each cell, and thus synchronises neatly with \pkg{ggplot2} graphics. The motivating application is studying pedestrian behavior, based on counts which are captured at hourly interval by sensors scattered around the city. Facetting by the usual features such as day and month, was insufficient to examine the behavior. Making displays on a monthly calendar format helps to understand pedestrian patterns relative to  events such as work days, weekends, holidays, and special events. The layout algorithm has several format options and variations. It is implemented in the R package \pkg{sugrrants}.

keywords:
  # at least one keyword must be supplied
  formatted: [data visualization, statistical graphics, time series, R package, grammar of graphics]
  plain:     [data visualization, statistical graphics, time series, R package, grammar of graphics]
preamble: >
  \usepackage{amsmath}
  \usepackage{tikz}
output: 
  bookdown::pdf_book:
    base_format: rticles::jss_article
  citation_package: biblatex
bibliography: ["references.bib", "packages.bib"]
---

```{r initial, echo = FALSE, cache = FALSE, include = FALSE}
library(knitr)
opts_chunk$set(
  warning = FALSE, message = FALSE, echo = FALSE, 
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.show = 'hold', cache = TRUE, external = TRUE, dev = "pdf",
  fig.height = 5, fig.width = 8, out.width = "\\textwidth"
)
read_chunk('src/main.R')
```

```{r load}
```

# Introduction

This work was originally motivated by studying foot traffic in the city of Melbourne [@ped]. There have been 43 sensors installed that count pedestrians every hour across the downtown area up until the end of 2016 (see Figure \ref{fig:ped-map}). The dataset can shed light into understanding people's daily schedules, or assisting administration and business planning. We start off with the conventional time series plot to catch a glimpse of such data. A small multiples, shown in Figure \ref{fig:time-series-plot}, gives an overall picture of the foot traffic at 3 different sensors. Figure \ref{fig:facet-time} provides more details of the temporal patterns by faceting on day of the week. The sensor data, like many temporal datasets on human behaviors, lends itself to a number of exploratory data visualization challenges:

1. Variations primarily result from multiple time scales including time of day, day of week, and day of year (such as public holiday and recurring events).
2. Since the data are often collected at sub-daily frequencies, they typically involve a large number of observations.
3. Measurements of a single type are made at multiple locations at a given time point, which creates the need for comparing and contrasting between locations.

```{r ped-map, fig.width = 4, out.width = "0.55\\linewidth", fig.cap = "(ref:ped-map-cap)"}
```

(ref:ped-map-cap) Map of the Melbourne city with purple dots indicating sensor locations.

```{r time-series-plot, fig.height = 6, fig.cap = "(ref:time-series-plot-cap)"}
```

(ref:time-series-plot-cap) Time series plot about the number of pedestrians in 2016 measured at 3 different sensors in the city of Melbourne. Coloured by the sensors, small multiples of lines show that the foot traffic varies from one sensor to another in terms of both time and number. The weekly patterns look distinctive across these 3 sensors. There is an eye-catching spike which occurred at State Library, caused by the annual event--White Night--on 20th of February.

```{r facet-time, fig.height = 6, fig.cap = "(ref:facet-time-cap)"}
```

(ref:facet-time-cap) Hourly pedestrian counts faceted by sensors and days of the week using lines. It features at least two types of seasons--time of day and day of week--across all the sensors. The temporal patterns are subject to the sensor locations too.

A collection of data plots, organized in a familiar format, offer a useful and intuitive way to understand complex data. 
@Wickham2012glyph embedded a sequence of daily temperature line charts into a glyph map according to the spatial locations; and @R-geofacet provided methods in the \pkg{geofacet} package to arrange data plots into a grid, while preserving the geographical layout. They both attempt to enable one to see the spatial context of each self-contained data plot.

Alternatively, calendar-based graphics turn out to be a useful tool in unfolding human-related activities over time. For example, @VanWijkCluster1999 developed a calendar view of the heatmap to represent the number of employees in the work place over a year, where colours indicate different clusters derived from the days. It contrasts weekdays and weekends, highlights public holidays, and presents other known seasons like school vacations; all of which have influence over the turn-outs in the office. The calendar-based heatmap was implemented in two R packages: \pkg{ggTimeSeries} [@R-ggTimeSeries] and \pkg{ggcal} [@R-ggcal]. However, these techniques are limited to colour-encoding graphics and are unable to use time scales smaller than day. Time of day, which serves as one of the most important aspects in explaining variations arisen from pedestrian sensor data, will be neglected through daily aggregation. Additionally if simply using coloured blocks rather than curves, it may become perceptually difficult to estimate the shape positions and changes, although using the curves comes with the cost of more display capacity [@cleveland1984graphical; @lam2007overview].

We propose a new algorithm via linear algebra tools to go beyond the calendar-based heatmap. The approach is developed with these conditions in mind: (1) to make time of day present in addition to the existing temporal components such as day of week and day of year, (2) to incorporate line graphs and other types of glyphs into the graphical toolkit for the calendar layout, (3) to enable an overlaying plot consisting of multiple time series. The proposed algorithm has been implemented in the \code{frame_calendar} function in the \pkg{sugrrants} package [@R-sugrrants] using \proglang{R} [@R-base].

The remainder of the paper is organized as follows. Section \ref{sec:algorithm} demonstrates the construction of the calendar layout in depth. Section \ref{sec:opt} lists and describes the options that come with the \code{frame_calendar} function. Section \ref{sec:examples} presents some variations of its usage. Section \ref{sec:discussion} discusses the advantages and disadvantages of the method.

# Construction 
\label{sec:algorithm}

Figure \ref{fig:flinders-2016} shows the line glyphs framed in the monthly calendar over the year of 2016. This is achieved by the \code{frame_calendar} function computing the new coordinates according to the input data variables; in turn the rearranged data values are plotted using the \pkg{ggplot2} package [@R-ggplot2], which is an implementation of the grammar of graphics [@wilkinson2006grammar; @wickham2010layered]. 

```{r flinders-2016, fig.height = 6.5, fig.cap = "(ref:flinders-2016-cap)"}
```

(ref:flinders-2016-cap) The calendar-based display of hourly foot traffic at Flinders Street Station using line glyphs. The arrangement of the data into a 3 by 4 monthly grid represents all the traffic in 2016. The disparities between weekday and weekend along with public holiday are immediately apparent.

The algorithm for constructing a calendar plot uses linear algebra, similar to that used in the glyph map displays for spatio-temporal data [@Wickham2012glyph]. To make a year long calendar, requires cells for days, embedded in blocks corresponding to months, organized into a grid layout for a year. Each month can be captured with 35 (5 $\times$ 7) cells, where the top left is Monday of week 1, and the bottom right is Sunday of week 5. These cells provide a micro canvas on which to plot the data. The first day of the month could be any of Monday-Sunday, which is determined by the year of the calendar. Months are of different length days, ranging from 28-31, and each month could extend over six weeks but the convention in these months is to wrap the last few days up to the top row of the block. The notation for creating these cells is as follows: 

* $k = 1, \dots , 7$ is the day of the week that is the first day of the month.
* $d = 28, 29, 30$ or $31$ representing the number of days in any month.
* $(i, j)$ is the grid position where $1 \le i \le 5$ is week within the month, $1 \le j \le 7$, is day of the week. 
* $g = k, \dots,(k+d)$ indexes the day in the month, inside the 35 possible cells.

The grid position for any day in the month is given by

\begin{equation}
  \begin{aligned}
  i &= \lceil (g \mod 35) / 7\rceil, \\
  j &= g \mod 7. \label{eq:grid}
  \end{aligned}
\end{equation}

Figure \ref{fig:month-diagram} illustrates this $(i,j)$ layout for a month where $k=5$. 

```{r month-diagram, out.width = "360pt", out.height = "250pt", fig.cap = "(ref:month-diagram-cap)"}
include_graphics("figure/month.pdf")
```

(ref:month-diagram-cap) Illustration of the indexing layout for cells in a month.

To create the layout for a full year, $(m, n)$ denotes the position of the month arranged in the plot, where $1 \le m \le M$ and $1 \le n \le N$. Between each month requires some small amount of white space, label this $b$. Figure \ref{fig:year-diagram} illustrates this  layout.

```{r year-diagram, out.width = "360pt", out.height = "250pt", fig.cap = "(ref:year-diagram-cap)"}
include_graphics("figure/year.pdf")
```

(ref:year-diagram-cap) Illustration of the indexing layout for months of one year.

Each cell forms a canvas on which to draw the data. Consider the canvas to have limits $[0, 1]$ horizontally and vertically. For the pedestrian sensor data, within each cell, hour is plotted horizontally and count is plotted vertically. Each variable is scaled to have values in $[0,1]$, using the minimum and maximum of all the data values to be displayed, assuming fixed scales. Let $h$ be the scaled hour, and $c$ the scaled count.

Then the final points for making the calendar line plots of the pedestrian sensor data is given by:

\begin{equation}
  \begin{aligned}
  x &= i + (i - 1) \times m + (m - 1) \times b + h, \\
  y &= -j - (j - 1) \times n - (n - 1) \times b + c. \label{eq:final}
  \end{aligned}
\end{equation}

Note that for the vertical direction, the top left is the starting point of the grid which is why subtraction is performed. The resulting negative values place the cells down the vertical direction. Within each cell, the starting position is the bottom left. 

Reference lines dividing each cell and block as well as labels indicating weekday and month are also provided in order to make calendar-based graphics more accessible and informative. 

Regarding the monthly calendar, the major reference lines separate every month panel and the minor ones separate every cell, represented by the thick and thin lines respectively. The major reference lines are placed surrounding every month block: for each $m$, the vertical lines are determined by $\min{(x)}$ and $\max{(x)}$; for each $n$, the horizontal lines are given by $\min{(y)}$ and $\max{(y)}$. The minor reference lines are placed on the left side of every cell: for each $i$, the vertical division is $\min{(x)}$; for each $j$, the horizontal is $\min{(y)}$.

The abbreviated month labels located on the top left are obtained through $(\min{(x)}, \max{(y)})$ for every $(m, n)$. The weekday texts with a single letter are uniformly positioned on the bottom of the whole canvas, that is $\min{(y)}$, with the central position of a cell $x / 2$ for each $j$.

# Options
\label{sec:opt}

There are several options provided for the \code{frame_calendar} function to initialize and adjust the display of a calender plot:

```
frame_calendar(
  data, x, y, date, calendar = "monthly", dir = "h", sunday = FALSE, 
  nrow = NULL, ncol = NULL, polar = FALSE, scale = "fixed",
  width = 0.95, height = 0.95
)
```

Assuming that tidy data [@wickham2014tidy] is the underlying data structure, the parameter \code{x} takes a variable that will be mapped to the horizontal axis and the parameter \code{y} mapped to the vertical axis for plot construction. In Figure \ref{fig:flinders-2016}, for example, the \code{x} is the variable specifying the time of the day, and the \code{y} is the variable representing the hourly counts. The \code{date} argument is given by the date variable that determines the correct order of the calendar layout. 

The algorithm can be extended to display data from a single month up to a few years. The number of rows and columns in the layout can be specified with the arguments \code{nrow} and \code{ncol}. If the one would like to visualize data spanning over three years, for example, \code{nrow = 12} and \code{ncol = 3} would be an appropriate choice when assessing the differences of a given month across the years.

In Section \ref{sec:algorithm} we only illustrated that grids are laid out horizontally. The vertical direction can be enabled by swapping $i$ and $j$ in equation \ref{eq:grid}, which occurs when the argument \code{dir} is set to \code{"v"}. This benefits users who are accustomed to calendars that are organized vertically, which is common in some countries. Next we shall describe some of the arguments that allow for alternate displays.

## Layouts

The algorithm described in Section \ref{sec:algorithm} is for the most common calendar layout, the "monthly" calendar, but it can be simplified to accommodate the other two types of calendar formats. One is comprised of days of a week in columns and weeks of a year in rows, and the other is days of a month in columns and months of a year in rows, which we refer to as the "weekly" and "daily" calendar, respectively. The layout to be used is controlled by the \code{calendar} argument. The weekly calendar puts more emphasis on days of a week over days of a year, whereas the daily calender does the opposite. The monthly calender can be considered as the advanced variant of both weekly and daily. Temporal patterns motivate which variant should be employed. The weekly calendar is appropriate if most of the variation can be characterised by days of the week. On the other hand, the daily calendar should be used when there is a yearly effect but not a weekly effect in the data. When both effects are present, the monthly calendar would be a better choice.

## Polar transformation

When \code{polar = TRUE}, the polar transformation is carried out on the data. The computation is similar to the one described in @Wickham2012glyph. Figure \ref{fig:flinders-polar} is considered as the spiral display of Figure \ref{fig:flinders-2016}.

```{r flinders-polar, fig.height = 6.5, fig.cap = "(ref:flinders-polar-cap)"}
```

(ref:flinders-polar-cap) Star plots of hourly pedestrian counts at Flinders Street Station, which are line charts placed in polar coordinates. The periodic behaviors on workdays are clearly visible.

## Scales

Section \ref{sec:algorithm} discusses the implementation applied to a fixed scale, which uses the range over all data values. The \code{scale} argument controls the scaling of the display. The fixed scale (\code{fixed}) is the default, meaning that the data values in all positions are scaled. The remaining options include: free scale within each cell (\code{free}), cells derived from the same day of the week (\code{free_wday}), or cells from the same day of the month (\code{free_mday}). The scaling allows for the comparisons of absolute or relative values, and the emphasis of different temporal variations.

Grouping the cells based on the same time period gives rise to the different scales. For example, the minimums and maximums obtained from each cell produce a local scale. The overall variation gives way to the individual shape. Figure \ref{fig:flinders-free} is an example of plotting line charts scaled locally. The daily variation is more distinctive compared to Figure \ref{fig:flinders-2016}. 

Similarly, the same $j$ indexing day of the week is grouped to compute the scales in days of a week; in other words, the same value within a given $j$ corresponds to the same position across each $j$\textsuperscript{th} cell. To construct the scales for days of the month, $g$ representing day of the month is used. This makes it easier to compare shape of a given day across each month block. The scaling option combined with the calendar layouts offers a number of varieties to construct the plot.

```{r flinders-free, fig.height = 6.5, fig.cap = "(ref:flinders-free-cap)"}
```

(ref:flinders-free-cap) Line glyphs on the calendar format showing hourly foot traffic at Flinders Street Station, scaled over all the days. The individual shape on a single day becomes more distinctive, however it is more difficult to compare the size of peaks between days.

# Variations
\label{sec:examples}

## Overlaying and faceting subsets

The comparison of one sensor to another adds additional insights to the dataset, which is commonly done with an overlaying plot such as Figure \ref{fig:overlay}. For instance, the dominant patterns that occurred at Flinders Street and Flagstaff train stations are driven by the commuters on work days; however, Flinders Street station has higher pedestrian counts during the weekends and public holidays. This suggests that Flagstaff station limits its functionality on non-work days, but various activities take place around the Flinders Street Station other than commuting. Figure \ref{fig:overlay} also shows that State Library follows a similar temporal trend as Flinders Street Station on non-work days. The nighttime events, such as White Night and New Year's Eve has barely affected the operation of Flagstaff Station but heavily affected the incoming and outgoing traffic to Flinders Street Station and State Library. 

```{r overlay, fig.height = 7, fig.cap = "(ref:overlay-cap)"}
```

(ref:overlay-cap) Overlaying line graphs of the 3 sensors in the monthly calendar. Flagstaff station is not as busy as the other two on non-work days.

To avoid the overlapping problem, the calendar layout can be embedded into a series of subplots for the different sensors. Figure \ref{fig:facet} presents the idea of faceting calendar plots. This allows comparing the overall structure between sensors, while emphasising individual sensor variation. 

```{r facet, fig.height = 11, fig.cap = "(ref:facet-cap)"}
```

(ref:facet-cap) Line charts, embedded in the 6 by 2 monthly calendar, coloured and faceted by the 3 sensors. The variations of an individual sensor are emphasised, and the shapes can be compared across the cells and sensors.

## Different types of plots

The \code{frame_calendar} function does not constrain itself to mapping only the temporal variable to the \code{x} argument. Figure \ref{fig:scatterplot} shows a lag scatterplot at Flinders Street Station, where the current hourly count is assigned to the \code{x} argument and the lagged hourly count to the \code{y} argument. This figure is organized in the daily calendar layout. It provides a visual tool for identifying repeating patterns. Figure \ref{fig:scatterplot} indicates two separate paths in the work-day glyphs, suggesting that an hour of a work day with many pedestrians is likely to be followed in the next hour with either greater or fewer numbers of pedestrians. However, this pattern is not present on non-work days. There is a bimodality on work days while there is unimodality on the rest of the days, which is also supported by Figure \ref{fig:flinders-2016}.

```{r scatterplot, fig.height = 5, fig.cap = "(ref:scatterplot-cap)"}
```

(ref:scatterplot-cap) Lag scatterplot in the daily calendar layout. Previous hour's count is plotted against each hour's count at Flinders Street Station to demonstrate the autocorrelation at lag 1. The correlation between them is more consistent on non-work days than work days.

The newly computed coordinates can work with more complicated plots, such as the boxplot. Figure \ref{fig:boxplot} uses the loess smooth line superimposed on side-by-side boxplots. It shows the distribution of hourly counts across all 43 sensors at a given time point during December. In general, bimodality features on work days whereas unimodality features on the rest of the days. The last week of December is the holiday season: people are off work on the day before Christmas, go shopping on the Boxing day, and stay out for the fireworks on New Year's Eve.

```{r boxplot, fig.height = 6.5, fig.cap = "(ref:boxplot-cap)"}
```

(ref:boxplot-cap) Side-by-side boxplot of hourly counts across all the 43 sensors in December of 2016, with the superimposing loess smooth line for each day. It shows the hourly distribution in the city as a whole. Christmas stands out as the quietest day in December.

```{r chn, dev.args = list(family = "GB1"), fig.height = 6.5, fig.cap = "(ref:chn-cap)"}
```

(ref:chn-cap) Figure \ref{fig:boxplot} with Chinese text labels.

# Discussion
\label{sec:discussion}

The calendar-based visualization provides data plots in the familiar (at least for the Western world) format of an everyday tool. Special events for the region, like Anzac Day in Australia, or Thanksgiving Day in the USA, more easily pop out to the viewer as public holidays, rather than a typical work day. 

This sort of layout may be useful for studying consumer trends, or human behavior, like the pedestrian patterns. It may not work so well for physical patterns like temperature, which are not typically affected by human activity.

```{r write-bib}
write_bib(.packages(), 'packages.bib')
```
